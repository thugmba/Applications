---
title: "THU GMBA Student Applications Dashboard"
format:
  html:
    theme: cosmo
    # toc: true
    page-layout: full
    css: styles.css
    embed-resources: true
---

```{r setup, include=FALSE}
library(tidyverse)
library(DT)
library(ggplot2)
library(plotly)

# Set seed for reproducibility
set.seed(123)

# Generate random data
n_students <- 50
# List of college names, their QS Rankings (2024) and country
college_data <- tibble(
  `College Name` = c(
    "National University of Singapore (NUS)", 
    "Nanyang Technological University (NTU)",
    "University of Hong Kong (HKU)",
    "Peking University",
    "Tsinghua University",
    "The University of Tokyo",
    "Seoul National University",
    "Korea Advanced Institute of Science and Technology (KAIST)",
    "The Chinese University of Hong Kong (CUHK)",
    "The Hong Kong University of Science and Technology (HKUST)",
    "Fudan University",
    "Korea University",
    "Indian Institute of Technology Bombay (IITB)",
    "National Taiwan University (NTU)",
    "Kyoto University"
  ),
  `QS Ranking` = c(
    8,  # NUS
    11, # NTU Singapore
    21, # HKU
    24, # Peking
    25, # Tsinghua
    27, # Tokyo
    33, # SNU
    40, # KAIST
    47, # CUHK
    41, # HKUST
    31, # Fudan
    86, # Korea University
    149,# IIT Bombay
    46, # NTU Taiwan
    33  # Kyoto
  ),
  Country = c(
    "Singapore",
    "Singapore",
    "Hong Kong",
    "China",
    "China",
    "Japan",
    "South Korea",
    "South Korea",
    "Hong Kong",
    "Hong Kong",
    "China",
    "South Korea",
    "India",
    "Taiwan",
    "Japan"
  )
)

# Use only countries that have universities in `college_data` for realistic pairing
countries <- unique(college_data$Country)

# List of departments
departments <- c("Computer Science", "Business Administration", "Data Science",
                "Electrical Engineering", "Mechanical Engineering",
                "Chemical Engineering", "Economics", "Mathematics",
                "Physics", "Biology")

# List of English test types
english_tests <- c("TOEFL", "IELTS", "Duolingo", "TOEIC")

# Generate random names
first_names <- c("James", "Mary", "John", "Patricia", "Robert", "Jennifer", 
                "Michael", "Linda", "William", "Elizabeth", "David", "Barbara", 
                "Richard", "Susan", "Joseph", "Jessica", "Thomas", "Sarah", 
                "Charles", "Karen", "Wei", "Li", "Ming", "Hui", "Yong", 
                "Xiao", "Jun", "Ravi", "Priya", "Amit", "Neha", "Raj", 
                "Sanjay", "Ji-hoon", "Min-ji", "Seo-yeon", "Jung-hoon")
last_names <- c("Smith", "Johnson", "Williams", "Brown", "Jones", "Garcia", 
                "Miller", "Davis", "Rodriguez", "Martinez", "Wang", "Li", 
                "Zhang", "Chen", "Liu", "Yang", "Patel", "Kumar", "Singh", 
                "Shah", "Kim", "Lee", "Park", "Choi", "Jung")

# Create the dataset
# Build a more realistic dataset: sample a country, then pick a college from that country
student_countries <- sample(countries, n_students, replace = TRUE)
selected_colleges <- vapply(student_countries, function(ct) {
  choices <- college_data$`College Name`[college_data$Country == ct]
  sample(choices, 1)
}, FUN.VALUE = character(1))

student_data <- tibble(
  `Row Number` = 1:n_students,
  Name = paste(
    sample(first_names, n_students, replace = TRUE),
    sample(last_names, n_students, replace = TRUE)
  ),
  Country = student_countries,
  `College Name` = selected_colleges,
  `QS Ranking` = college_data$`QS Ranking`[match(selected_colleges, college_data$`College Name`)],
  `College Department` = sample(departments, n_students, replace = TRUE),
  GPA = round(rnorm(n_students, mean = 3.6, sd = 0.3) %>% pmax(2.5) %>% pmin(4.5), 2),
  `English Test` = sample(english_tests, n_students, replace = TRUE)
)

# Generate English scores based on each student's test type
student_data <- student_data %>%
  rowwise() %>%
  mutate(
    `English Score` = case_when(
      `English Test` == "TOEFL" ~ as.character(sample(80:120, 1)),
      `English Test` == "IELTS" ~ as.character(sample(60:90, 1)/10),
      `English Test` == "Duolingo" ~ as.character(sample(100:160, 1)),
      `English Test` == "TOEIC" ~ as.character(sample(300:990, 1))
    )
  ) %>%
  ungroup() %>%
  mutate(
    `Chinese Skills` = sample(c('None', 'Beginner', 'Intermediate', 'Advanced'), n(), replace = TRUE),
    `Detail` = sapply(1:n(), function(i) {
      sprintf('<a href="#" onclick="return false;">View</a>')
    })
  )
```

## Student Applications Table

The table below shows student application information. All GPAs have been standardized to a 4.5 scale for consistent comparison across different educational systems. You can:

- Sort any column by clicking on the column header
- Show different number of entries per page
- Export the data to various formats

*Note: GPA Standardization*

- Maximum GPA: 4.5
- All GPAs have been converted to this scale to ensure fair comparison
- Original GPAs from different scales (e.g., 4.0, 5.0, or percentage systems) have been normalized to the 4.5 scale

```{r}
#| echo: false

datatable(student_data,
          extensions = c('Buttons', 'SearchPanes'),
          options = list(
            dom = 'Bfrtip',
            buttons = c('excel', 'pdf', 'print'),
            pageLength = 50,
            searchHighlight = TRUE,
            order = list(list(6, 'desc')),  # Sort by GPA by default (zero-based index)
            scrollX = TRUE,  # Enable horizontal scrolling
            autoWidth = FALSE,  # Disable auto width calculation
            initComplete = JS(
              "function(settings, json) {",
              "$(this.api().table().container()).css({'font-size': '14px'});",
              "}"
            )
          ),
          class = 'cell-border stripe hover',
          rownames = FALSE,
          escape = FALSE)  # Allow HTML in the table
```

## Application Statistics

### 1. Applications by Country
```{r}
#| echo: false
#| warning: false

# Create country distribution plot
country_plot <- student_data %>%
  count(Country) %>%
  ggplot(aes(x = reorder(Country, n), y = n)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  coord_flip() +
  theme_minimal() +
  labs(title = "Number of Applications by Country",
       x = "Country",
       y = "Number of Applications")

ggplotly(country_plot)
```

### 2. Applications by University
```{r}
#| echo: false
#| warning: false

# Create university distribution plot
univ_plot <- student_data %>%
  count(`College Name`) %>%
  ggplot(aes(x = reorder(`College Name`, n), y = n)) +
  geom_bar(stat = "identity", fill = "lightblue") +
  coord_flip() +
  theme_minimal() +
  labs(title = "Number of Applications by University",
       x = "University",
       y = "Number of Applications") +
  theme(axis.text.y = element_text(size = 8))

ggplotly(univ_plot)
```

### 3. Applications by Department
```{r}
#| echo: false
#| warning: false

# Create department distribution plot
dept_plot <- student_data %>%
  count(`College Department`) %>%
  ggplot(aes(x = reorder(`College Department`, n), y = n)) +
  geom_bar(stat = "identity", fill = "lightgreen") +
  coord_flip() +
  theme_minimal() +
  labs(title = "Number of Applications by Department",
       x = "Department",
       y = "Number of Applications")

ggplotly(dept_plot)
```

### 4. GPA Distribution
```{r}
#| echo: false
#| warning: false
#| message: false

# Create GPA distribution plot
gpa_plot <- ggplot(student_data, aes(x = GPA)) +
  geom_histogram(aes(y = ..density..), bins = 20, fill = "skyblue", color = "black") +
  geom_density(color = "red", linewidth = 1) +
  theme_minimal() +
  labs(title = "Distribution of GPAs",
       x = "GPA",
       y = "Density")

ggplotly(gpa_plot)
```

### 5. English Test Distribution
```{r}
#| echo: false
#| warning: false

# Create English Test pie chart
test_dist <- student_data %>%
  count(`English Test`) %>%
  mutate(percentage = n/sum(n) * 100,
         label = paste0(`English Test`, "\n", round(percentage, 1), "%"))

pie_plot <- plot_ly(test_dist, labels = ~label, values = ~n, type = 'pie',
                    textinfo = 'label',
                    hoverinfo = 'text',
                    text = ~paste(`English Test`, "\nCount:", n),
                    marker = list(colors = c("rgb(31, 119, 180)", "rgb(255, 127, 14)", 
                                          "rgb(44, 160, 44)", "rgb(214, 39, 40)"))) %>%
  layout(title = "Distribution of English Tests",
         showlegend = FALSE)

pie_plot
```

### 6. English Score Distribution per Test Type

#### TOEFL Score Distribution
```{r}
#| echo: false
#| warning: false

# TOEFL Distribution (80-120)
toefl_data <- student_data %>% filter(`English Test` == "TOEFL")
if(nrow(toefl_data) > 0) {
  toefl_plot <- plot_ly(x = ~as.numeric(toefl_data$`English Score`),
                        type = "histogram",
                        marker = list(color = "skyblue",
                                     line = list(color = "black", width = 1)),
                        nbinsx = 20,
                        name = "TOEFL Scores") %>%
    layout(title = "TOEFL Score Distribution",
           xaxis = list(title = "TOEFL Score (80-120)", range = c(80, 120)),
           yaxis = list(title = "Count"),
           showlegend = FALSE)

  toefl_plot
} else {
  cat("No TOEFL data available")
}
```

#### IELTS Score Distribution
```{r}
#| echo: false
#| warning: false

# IELTS Distribution (6.0-9.0)
ielts_data <- student_data %>% filter(`English Test` == "IELTS")
if(nrow(ielts_data) > 0) {
  ielts_plot <- plot_ly(x = ~as.numeric(ielts_data$`English Score`),
                        type = "histogram",
                        marker = list(color = "lightgreen",
                                     line = list(color = "black", width = 1)),
                        nbinsx = 20,
                        name = "IELTS Scores") %>%
    layout(title = "IELTS Score Distribution",
           xaxis = list(title = "IELTS Score (6.0-9.0)", range = c(6, 9)),
           yaxis = list(title = "Count"),
           showlegend = FALSE)

  ielts_plot
} else {
  cat("No IELTS data available")
}
```

#### Duolingo Score Distribution
```{r}
#| echo: false
#| warning: false

# Duolingo Distribution (100-160)
duo_data <- student_data %>% filter(`English Test` == "Duolingo")
if(nrow(duo_data) > 0) {
  duo_plot <- plot_ly(x = ~as.numeric(duo_data$`English Score`),
                      type = "histogram",
                      marker = list(color = "pink",
                                   line = list(color = "black", width = 1)),
                      nbinsx = 20,
                      name = "Duolingo Scores") %>%
    layout(title = "Duolingo Score Distribution",
           xaxis = list(title = "Duolingo Score (100-160)", range = c(100, 160)),
           yaxis = list(title = "Count"),
           showlegend = FALSE)

  duo_plot
} else {
  cat("No Duolingo data available")
}
```

#### TOEIC Score Distribution
```{r}
#| echo: false
#| warning: false

# TOEIC Distribution (300-990)
toeic_data <- student_data %>% filter(`English Test` == "TOEIC")
if(nrow(toeic_data) > 0) {
  toeic_plot <- plot_ly(x = ~as.numeric(toeic_data$`English Score`),
                        type = "histogram",
                        marker = list(color = "lightblue",
                                     line = list(color = "black", width = 1)),
                        nbinsx = 20,
                        name = "TOEIC Scores") %>%
    layout(title = "TOEIC Score Distribution",
           xaxis = list(title = "TOEIC Score (300-990)", range = c(300, 990)),
           yaxis = list(title = "Count"),
           showlegend = FALSE)

  toeic_plot
} else {
  cat("No TOEIC data available")
}
```

### 7. Chinese Level Distribution
```{r}
#| echo: false
#| warning: false

# Create Chinese Skills pie chart
chinese_dist <- student_data %>%
  count(`Chinese Skills`) %>%
  mutate(percentage = n/sum(n) * 100,
         label = paste0(`Chinese Skills`, "\n", round(percentage, 1), "%"))

chinese_pie <- plot_ly(chinese_dist, labels = ~label, values = ~n, type = 'pie',
                      textinfo = 'label',
                      hoverinfo = 'text',
                      text = ~paste(`Chinese Skills`, "\nCount:", n),
                      marker = list(colors = c("rgb(31, 119, 180)", "rgb(255, 127, 14)", 
                                            "rgb(44, 160, 44)", "rgb(214, 39, 40)"))) %>%
  layout(title = "Distribution of Chinese Language Skills",
         showlegend = FALSE)

chinese_pie
```
